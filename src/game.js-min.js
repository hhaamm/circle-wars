if(typeof window=="undefined"){var WallModule=require("./wall.js");Wall=WallModule.Wall;wallMaterials=WallModule.wallMaterials;StoneMaterial=WallModule.StoneMaterial;setIntervalWithContext=require("./util.js").setIntervalWithContext;var WeaponModule=require("./weapon.js");weaponTypes=WeaponModule.weaponTypes;uuid=require("node-uuid");Client=require("./client.js")}var Game=function(b,c,a,d){this.ctx=b;this.WIDTH=c;this.HEIGHT=a;this.players=[];this.entities=[];this.removeEntities=[];this.multiplayer=d.multiplayer;this.isServer=d.multiplayer=="server";this.isClient=d.multiplayer=="client";this.isSinglePlayer=!d.multiplayer;this.isMultiplayer=!!d.multiplayer;this.onGameOver=function(){};var e={maxWalls:50,weaponGeneration:0.999,minWalls:0};this.opts=d||{};this.opts=extend({},e,this.opts);this.init=function(){var f=this;if(!this.multiplayer){var h={left:65,right:68,forward:87,backward:83,shoot:32};var g={left:37,right:39,forward:38,backward:40,shoot:13};this.player1=new Player(100,100,1,"Player 1",h);this.player2=new Player(500,400,2,"Player 2",g);$(document).keydown(function(i){f.player1.onKeyDown(i);return false});$(document).keyup(function(i){f.player1.onKeyUp(i);return false});$(document).keydown(function(i){f.player2.onKeyDown(i);return false});$(document).keyup(function(i){f.player2.onKeyUp(i);return false});this.addEntity(this.player1);this.addEntity(this.player2);this.players.push(this.player1);this.players.push(this.player2)}this.__generateWalls();this.resources=new ResourceLoader();this.resources.loadResources(function(){f.runInterval=setIntervalWithContext(f.run,10,f)})};this.initServer=function(){var f=this;this.lastFrameTime=Date.now();this.framesPerSecond=60;this.milisecsPerFrame=1000/60;this.players=[];this.__generateWalls();f.runInterval=setIntervalWithContext(f.runNextFrames,10,f)};this.__generateWalls=function(){debug(this.opts);var h=Math.floor(Math.random()*(this.opts.maxWalls-this.opts.minWalls-1))+this.opts.minWalls;var l=new Wall(0,0,{});debug("Walls: "+h);var g,m;for(var j=0;j<h;j++){g=Math.floor(Math.random()*this.WIDTH/l.width)*l.width;m=Math.floor(Math.random()*this.HEIGHT/l.height)*l.height;if(this.multiplayer||((g!=this.player1.x-this.player1.radius/2||m!=this.player1.y-this.player1.radius/2)&&(g!=this.player2.x-this.player2.radius/2|m!=this.player2.y-this.player2.radius/2))){var k=wallMaterials[Math.floor(Math.random()*wallMaterials.length)];var f=new Wall(g,m,k,uuid.v1());this.addEntity(f)}}for(j=0;j<this.WIDTH/20;j++){this.addEntity(new Wall(j*20,0,StoneMaterial,uuid.v1()));this.addEntity(new Wall(j*20,this.HEIGHT-20,StoneMaterial,uuid.v1()))}for(j=0;j<this.HEIGHT/20;j++){this.addEntity(new Wall(0,j*20,StoneMaterial,uuid.v1()));this.addEntity(new Wall(this.WIDTH-20,j*20,StoneMaterial,uuid.v1()))}};this.initClient=function(g){var f=this;this.player1=g;this.addEntity(g);this.players.push(g);this.client=new Client(this,this.socket);this.lastFrameTime=Date.now();this.framesPerSecond=60;this.milisecsPerFrame=1000/60;this.resources=new ResourceLoader();this.resources.loadResources(function(){f.runInterval=setIntervalWithContext(f.runNextFrames,10,f)})};this.addEntity=function(f,g){f.setGame(this);this.entities.push(f);if(this.isClient&&g){switch(f.type){case"bullet":debug(f);debug("Sending bullet to server");f.id=uuid.v1();f.generateRandomNumbers();this.client.addBullet(f);break}}};this.removeEntity=function(f){this.removeEntities.push(f)};this.runNextFrames=function(){var g=Date.now();var h=(g-this.lastFrameTime)/this.milisecsPerFrame;this.lastFrameTime=this.lastFrameTime+this.milisecsPerFrame*Math.floor(h);for(var f=0;f<h;f++){this.process()}if(!this.isServer){this.draw()}};this.draw=function(){this.clear();for(var f=0;f<this.entities.length;f++){this.entities[f].draw(this.ctx)}this.drawUI()};this.process=function(){var g=this;this.currentTime=new Date().getTime();var n;for(n=0;n<this.entities.length;n++){this.entities[n].process()}if(this.removeEntities.length){for(var l=0;l<this.removeEntities.length;l++){var h=this.removeEntities[l];var k=g.entities.indexOf(h);if(k>-1){g.entities.splice(k,1)}}this.removeEntities=[]}if(!this.multiplayer&&(this.player1.life<=0||this.player2.life<=0)){this.stop();this.ctx.fillStyle="white";this.ctx.font="bold 30px Arial";this.ctx.fillText("Game Over",100,200);this.ctx.font="bold 20px Arial";if(this.player1.life>0){this.ctx.fillText("Player 1 Wins",100,300)}else{this.ctx.fillText("Player 2 Wins",100,300)}this.onGameOver()}if(this.isClient&&this.player1.life<=0){this.onGameOver()}if(!this.isClient&&Math.random()>this.opts.weaponGeneration&&this.getEntityCount("weapon")<10){debug("Added weapon");var f=Math.floor(Math.random()*weaponTypes.length);var m=this.addWeapon(f,null,null);if(this.isServer){this.socket.emit("new weapon",{position:{x:m.x,y:m.y},id:m.id,weaponTypeIndex:f});debug("new weapon generated "+m.name+" "+m.id);debug("Number of weapons: "+this.getEntityCount("weapon"))}}};this.stop=function(){clearInterval(this.runInterval)};this.addWeapon=function(h,g,k,j){var f=weaponTypes[h];var i;if(this.isServer||this.isSinglePlayer){i=new f(Math.floor(Math.random()*this.WIDTH),Math.floor(Math.random()*this.HEIGHT));i.x-=i.width/2;i.y-=i.height/2;i.id=uuid.v1();i.weaponTypeIndex=h}else{i=new f(g,k);i.id=j}this.addEntity(i);return i};this.getEntityCount=function(g){var h=0;for(var f=0;f<this.entities.length;f++){if(this.entities[f].type==g){h++}}return h};this.getEntities=function(g){var h=[];for(var f=0;f<this.entities.length;f++){if(this.entities[f].type==g){h.push(this.entities[f])}}return h};this.drawUI=function(){if(!this.isServer&&this.player1){this.drawPlayerStats(20,30,this.player1)}if(!this.multiplayer){this.drawPlayerStats(this.WIDTH-90,30,this.player2)}};this.drawPlayerStats=function(f,h,g){this.ctx.fillStyle="white";this.ctx.font="bold 16px Arial";this.ctx.fillText(g.name,f,h);this.ctx.fillText(g.getWeapon().name+" "+(g.getWeapon().bullets>0?g.getWeapon().bullets:""),f,h+20);this.ctx.fillText(g.life,f,h+40)};this.clear=function(){b.fillStyle="brown";b.fillRect(0,0,this.WIDTH,this.HEIGHT)};this.addPlayerIfNotPresent=function(g){if(!this.isMultiplayer){throw"This method should only be used in Multiplayer"}var h=false;for(var f=0;f<this.players.length;f++){if(this.players[f].id==g.id){h=true;break}}if(!h){this.players.push(g);this.addEntity(g);return true}return false};this.getPlayer=function(f){for(var g=0;g<this.players.length;g++){if(this.players[g].id==f){return this.players[g]}}return null};this.removePlayer=function(f){var g=this.getPlayer(f);console.log("removePlayer. Index: "+this.players.indexOf(g));if(this.players.indexOf(g)!==-1){this.players.splice(this.players.indexOf(g),1)}if(this.entities.indexOf(g)!==-1){this.entities.splice(this.entities.indexOf(g),1)}console.log("Number of players: "+this.players.length)};this.trigger=function(f,g){switch(f){case"weapon taken":console.log("Weapon taken");this.socket.emit("weapon taken",g);break}};this.triggerServer=function(f,g){this.socket.emit(f,g)};this.getEntityById=function(h){var f;for(var g=0;g<this.entities.length;g++){if(this.entities[g].id==h){f=this.entities[g];break}}return f}};function extend(){for(var b=1;b<arguments.length;b++){for(var a in arguments[b]){if(arguments[b].hasOwnProperty(a)){arguments[0][a]=arguments[b][a]}}}return arguments[0]}if(typeof window=="undefined"){module.exports=Game};